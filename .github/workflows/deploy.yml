name: Deploy to Absolute Hosting

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: List files to deploy
        run: |
          echo "Files to be deployed:"
          ls -la
          echo ""
          echo "HTML, CSS, JS files:"
          find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | head -10

      - name: Verify FTP Secrets
        run: |
          if [ -z "${{ secrets.FTP_SERVER }}" ]; then
            echo "❌ FTP_SERVER secret is missing!"
            exit 1
          fi
          if [ -z "${{ secrets.FTP_USERNAME }}" ]; then
            echo "❌ FTP_USERNAME secret is missing!"
            exit 1
          fi
          if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then
            echo "❌ FTP_PASSWORD secret is missing!"
            exit 1
          fi
          echo "✅ All FTP secrets are configured"
          echo "FTP Server: ${{ secrets.FTP_SERVER }}"
          echo "FTP Username: ${{ secrets.FTP_USERNAME }}"
          echo ""
          echo "⚠️  TIP: Make sure FTP_PASSWORD in GitHub Secrets matches EXACTLY what works in FileZilla"

      - name: FTPS Deploy (with explicit TLS)
        id: ftps-deploy
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          local-dir: ./
          server-dir: ./public_html/  # Common web root - try ./www/ or ./htdocs/ if this doesn't work
          dangerous-clean-slate: false
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            README.md
            .gitignore
            DEPLOYMENT_TROUBLESHOOTING.md

      - name: FTPS Legacy Deploy (fallback)
        if: steps.ftps-deploy.outcome == 'failure'
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps-legacy
          local-dir: ./
          server-dir: ./
          dangerous-clean-slate: false
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            README.md
            .gitignore
            DEPLOYMENT_TROUBLESHOOTING.md


      - name: Deployment Summary
        if: success()
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Files should now be available on your website."
          echo ""
          echo "If your website isn't loading, check:"
          echo "1. Clear browser cache (Ctrl+Shift+R or Cmd+Shift+R)"
          echo "2. Try accessing in Incognito/Private mode"
          echo "3. Check file timestamps in hosting control panel to verify files updated"
          echo "4. Wait 1-2 minutes for DNS/caching to update"
          echo ""
          echo "Files deployed to: ./public_html/ directory"

      - name: Deployment Failed - Troubleshooting
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo ""
          echo "Common fixes:"
          echo "1. Double-check FTP_PASSWORD in GitHub Secrets matches EXACTLY what works in FileZilla"
          echo "2. Make sure there are NO extra spaces before/after the password in GitHub Secrets"
          echo "3. Try deleting and re-adding the FTP_PASSWORD secret"
          echo "4. Verify FTP_USERNAME is exactly: sean@katalystlabs.co.za (or whatever format worked in FileZilla)"
          echo "5. Wait a few minutes and try again (sometimes servers block after multiple failed attempts)"

