name: Deploy to Absolute Hosting

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: List files to deploy
        run: |
          echo "Files to be deployed:"
          ls -la
          echo ""
          echo "HTML, CSS, JS files:"
          find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | head -10

      - name: Verify FTP Secrets
        run: |
          if [ -z "${{ secrets.FTP_SERVER }}" ]; then
            echo "‚ùå FTP_SERVER secret is missing!"
            exit 1
          fi
          if [ -z "${{ secrets.FTP_USERNAME }}" ]; then
            echo "‚ùå FTP_USERNAME secret is missing!"
            exit 1
          fi
          if [ -z "${{ secrets.FTP_PASSWORD }}" ]; then
            echo "‚ùå FTP_PASSWORD secret is missing!"
            exit 1
          fi
          echo "‚úÖ All FTP secrets are configured"
          echo "FTP Server: ${{ secrets.FTP_SERVER }}"
          echo "FTP Username: ${{ secrets.FTP_USERNAME }}"
          echo ""
          echo "‚ö†Ô∏è  TIP: Use the 'katalyst' special FTP account (logs into /home/katalyst)"
          echo "‚ö†Ô∏è  TIP: Password might be your main hosting account password, or set it in control panel"

      - name: FTP Deploy (try plain FTP first - faster, no encryption)
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          local-dir: ./
          server-dir: ./public_html/  # Deploy to public_html in /home/katalyst directory
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose
          state-name: github-actions-state.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            README.md
            .gitignore
            DEPLOYMENT_TROUBLESHOOTING.md
        continue-on-error: true
        id: ftp-deploy

      - name: FTPS Deploy (fallback if plain FTP fails)
        if: steps.ftp-deploy.outcome == 'failure'
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          local-dir: ./
          server-dir: ./public_html/  # Deploy to public_html in /home/katalyst directory
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose
          state-name: github-actions-state.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            README.md
            .gitignore
            DEPLOYMENT_TROUBLESHOOTING.md


      - name: Verify Deployment
        if: success()
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo ""
          echo "üìã Files that should be on server:"
          echo "  - index.html"
          echo "  - styles.css"
          echo "  - script.js"
          echo ""
          echo "üîç Next steps to verify:"
          echo "1. Check your hosting File Manager (public_html folder)"
          echo "2. Look at file 'Last Modified' timestamps - they should be recent"
          echo "3. Clear browser cache (Ctrl+Shift+R or Cmd+Shift+R)"
          echo "4. Try accessing in Incognito/Private mode"

      - name: Deployment Failed - Troubleshooting
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo ""
          echo "üîç Common issues:"
          echo "1. Connection timeout/reset during upload (network issue)"
          echo "2. Server connection limits reached"
          echo "3. FTP passive mode issues"
          echo ""
          echo "‚úÖ What worked:"
          echo "- Login successful (credentials are correct!)"
          echo "- Connected to server"
          echo "- Created public_html directory"
          echo ""
          echo "‚ö†Ô∏è  What failed:"
          echo "- Connection dropped during file upload"
          echo ""
          echo "‚ÑπÔ∏è  Note: Tried plain FTP first, then FTPS if needed"
          echo ""
          echo "üîÑ Solution:"
          echo "The workflow will automatically retry. If it fails again:"
          echo "1. Wait a few minutes and try deploying again"
          echo "2. Check if your hosting has FTP connection limits"
          echo "3. Contact Absolute Hosting if connection issues persist"

