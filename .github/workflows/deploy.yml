name: Deploy to Absolute Hosting

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: List files to deploy
        run: |
          echo "Files to be deployed:"
          ls -la
          echo ""
          echo "HTML, CSS, JS files:"
          find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | head -10

      - name: Verify SFTP Secrets
        env:
          SFTP_SERVER_VAR: ${{ secrets.SFTP_SERVER }}
          SFTP_USERNAME_VAR: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD_VAR: ${{ secrets.SFTP_PASSWORD }}
          FTP_SERVER_VAR: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME_VAR: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD_VAR: ${{ secrets.FTP_PASSWORD }}
        run: |
          # Use existing FTP secrets or SFTP-specific ones
          if [ -n "$SFTP_SERVER_VAR" ]; then
            SFTP_SERVER="$SFTP_SERVER_VAR"
          else
            SFTP_SERVER="$FTP_SERVER_VAR"
          fi
          
          if [ -n "$SFTP_USERNAME_VAR" ]; then
            SFTP_USERNAME="$SFTP_USERNAME_VAR"
          else
            SFTP_USERNAME="$FTP_USERNAME_VAR"
          fi
          
          if [ -n "$SFTP_PASSWORD_VAR" ]; then
            SFTP_PASSWORD="$SFTP_PASSWORD_VAR"
          else
            SFTP_PASSWORD="$FTP_PASSWORD_VAR"
          fi
          
          if [ -z "$SFTP_SERVER" ]; then
            echo "âŒ SFTP/FTP_SERVER secret is missing!"
            echo "ðŸ’¡ Add GitHub Secret: FTP_SERVER = ftp.katalystlabs.co.za"
            exit 1
          fi
          if [ -z "$SFTP_USERNAME" ]; then
            echo "âŒ SFTP/FTP_USERNAME secret is missing!"
            echo "ðŸ’¡ Add GitHub Secret: FTP_USERNAME = katalyst"
            exit 1
          fi
          if [ -z "$SFTP_PASSWORD" ]; then
            echo "âŒ SFTP/FTP_PASSWORD secret is missing!"
            echo "ðŸ’¡ Add GitHub Secret: FTP_PASSWORD = (your main hosting account password)"
            exit 1
          fi
          echo "âœ… All SFTP secrets are configured"
          echo "SFTP Server: $SFTP_SERVER"
          echo "SFTP Username: $SFTP_USERNAME"
          echo ""
          echo "â„¹ï¸  Using SFTP (SSH File Transfer Protocol) - recommended for cPanel primary FTP accounts"
          echo "ðŸ’¡ Using existing FTP_* secrets (or create SFTP_* secrets if preferred)"
          
          # Export for next step
          echo "SFTP_SERVER=$SFTP_SERVER" >> $GITHUB_ENV
          echo "SFTP_USERNAME=$SFTP_USERNAME" >> $GITHUB_ENV
          echo "SFTP_PASSWORD=$SFTP_PASSWORD" >> $GITHUB_ENV

      - name: SFTP Deploy using lftp
        run: |
          # Install lftp which supports password-based SFTP
          sudo apt-get update -qq
          sudo apt-get install -y lftp
          
          # Create lftp script for SFTP upload
          cat > /tmp/sftp_upload.lftp << EOF
          set sftp:auto-confirm yes
          set ssl:verify-certificate no
          open -u ${{ env.SFTP_USERNAME }},${{ env.SFTP_PASSWORD }} sftp://${{ env.SFTP_SERVER }}
          lcd .
          cd /home/katalyst/public_html
          mkdir -p /home/katalyst/public_html
          put -e index.html
          put -e styles.css
          put -e script.js
          bye
          EOF
          
          # Execute SFTP upload
          lftp -f /tmp/sftp_upload.lftp || {
            echo "âŒ SFTP upload failed!"
            echo "Check: 1) SFTP enabled on server, 2) Correct credentials, 3) Server allows password auth"
            exit 1
          }
          
          echo "âœ… Files uploaded via SFTP successfully!"


      - name: Verify Deployment
        if: success()
        run: |
          echo "âœ… SFTP Deployment completed successfully!"
          echo ""
          echo "ðŸ“‹ Files deployed to /home/katalyst/public_html/:"
          echo "  - index.html"
          echo "  - styles.css"
          echo "  - script.js"
          echo ""
          echo "ðŸ” Next steps to verify:"
          echo "1. Check your hosting File Manager (/home/katalyst/public_html/ folder)"
          echo "2. Look at file 'Last Modified' timestamps - they should be recent"
          echo "3. Visit your website and clear browser cache (Ctrl+Shift+R or Cmd+Shift+R)"
          echo "4. Try accessing in Incognito/Private mode"

      - name: Deployment Failed - Troubleshooting
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo ""
          echo "ðŸ” Common issues:"
          echo "1. Connection timeout/reset during upload (network issue)"
          echo "2. Server connection limits reached"
          echo "3. FTP passive mode issues"
          echo ""
          echo "âœ… What worked:"
          echo "- Login successful (credentials are correct!)"
          echo "- Connected to server"
          echo "- Created public_html directory"
          echo ""
          echo "âš ï¸  What failed:"
          echo "- SFTP connection or authentication issue"
          echo ""
          echo "ðŸ”„ Solution:"
          echo "1. Update GitHub Secrets (can use existing FTP_* secrets or create SFTP_* ones):"
          echo "   - FTP_SERVER or SFTP_SERVER: ftp.katalystlabs.co.za"
          echo "   - FTP_USERNAME or SFTP_USERNAME: katalyst"
          echo "   - FTP_PASSWORD or SFTP_PASSWORD: (your main hosting account password)"
          echo "2. SFTP uses port 22 (SSH) - ensure your hosting allows SFTP connections"
          echo "3. Try using server IP address (102.214.8.67) instead of domain name"
          echo "4. Verify SFTP is enabled - contact Absolute Hosting if needed"
          echo "5. Some hosts require SSH key instead of password - check with hosting support"

