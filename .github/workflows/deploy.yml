name: Deploy to Absolute Hosting

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: List files to deploy
        run: |
          echo "Files to be deployed:"
          ls -la
          echo ""
          echo "HTML, CSS, JS files:"
          find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | head -10

      - name: Verify SFTP Secrets
        env:
          SFTP_SERVER_VAR: ${{ secrets.SFTP_SERVER }}
          SFTP_USERNAME_VAR: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD_VAR: ${{ secrets.SFTP_PASSWORD }}
          FTP_SERVER_VAR: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME_VAR: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD_VAR: ${{ secrets.FTP_PASSWORD }}
        run: |
          # Use existing FTP secrets or SFTP-specific ones
          if [ -n "$SFTP_SERVER_VAR" ]; then
            SFTP_SERVER="$SFTP_SERVER_VAR"
          else
            SFTP_SERVER="$FTP_SERVER_VAR"
          fi
          
          if [ -n "$SFTP_USERNAME_VAR" ]; then
            SFTP_USERNAME="$SFTP_USERNAME_VAR"
          else
            SFTP_USERNAME="$FTP_USERNAME_VAR"
          fi
          
          if [ -n "$SFTP_PASSWORD_VAR" ]; then
            SFTP_PASSWORD="$SFTP_PASSWORD_VAR"
          else
            SFTP_PASSWORD="$FTP_PASSWORD_VAR"
          fi
          
          if [ -z "$SFTP_SERVER" ]; then
            echo "‚ùå SFTP/FTP_SERVER secret is missing!"
            echo "üí° Add GitHub Secret: FTP_SERVER = ftp.katalystlabs.co.za"
            exit 1
          fi
          if [ -z "$SFTP_USERNAME" ]; then
            echo "‚ùå SFTP/FTP_USERNAME secret is missing!"
            echo "üí° Add GitHub Secret: FTP_USERNAME = katalyst"
            exit 1
          fi
          if [ -z "$SFTP_PASSWORD" ]; then
            echo "‚ùå SFTP/FTP_PASSWORD secret is missing!"
            echo "üí° Add GitHub Secret: FTP_PASSWORD = (your main hosting account password)"
            exit 1
          fi
          echo "‚úÖ All SFTP secrets are configured"
          echo "SFTP Server: $SFTP_SERVER"
          echo "SFTP Username: $SFTP_USERNAME"
          echo ""
          echo "‚ÑπÔ∏è  Using plain FTP (port 21) - SFTP port 22 not accessible, FTPS not working"
          echo "üí° Using existing FTP_* secrets"
          
          # Export for next step
          echo "SFTP_SERVER=$SFTP_SERVER" >> $GITHUB_ENV
          echo "SFTP_USERNAME=$SFTP_USERNAME" >> $GITHUB_ENV
          echo "SFTP_PASSWORD=$SFTP_PASSWORD" >> $GITHUB_ENV

      - name: FTP Deploy (plain FTP - port 21)
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ env.SFTP_SERVER }}
          username: ${{ env.SFTP_USERNAME }}
          password: ${{ env.SFTP_PASSWORD }}
          protocol: ftp
          local-dir: ./
          server-dir: ./public_html/
          dangerous-clean-slate: false
          log-level: verbose
          state-name: github-actions-state.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            README.md
            .gitignore
            DEPLOYMENT_TROUBLESHOOTING.md


      - name: Verify Deployment
        if: success()
        run: |
          echo "‚úÖ FTP Deployment completed successfully!"
          echo ""
          echo "üìã Files deployed to /home/katalyst/public_html/:"
          echo "  - index.html"
          echo "  - styles.css"
          echo "  - script.js"
          echo ""
          echo "üîç Next steps to verify:"
          echo "1. Check your hosting File Manager (/home/katalyst/public_html/ folder)"
          echo "2. Look at file 'Last Modified' timestamps - they should be recent"
          echo "3. Visit your website and clear browser cache (Ctrl+Shift+R or Cmd+Shift+R)"
          echo "4. Try accessing in Incognito/Private mode"

      - name: Deployment Failed - Troubleshooting
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo ""
          echo "üîç Common issues:"
          echo "1. Connection timeout/reset during upload (network issue)"
          echo "2. Server connection limits reached"
          echo "3. FTP passive mode issues"
          echo ""
          echo "‚úÖ What worked:"
          echo "- Login successful (credentials are correct!)"
          echo "- Connected to server"
          echo "- Created public_html directory"
          echo ""
          echo "‚ö†Ô∏è  What failed:"
          echo "- FTP connection or upload issue"
          echo ""
          echo "üîÑ Solution:"
          echo "1. Verify credentials in GitHub Secrets:"
          echo "   - FTP_SERVER: ftp.katalystlabs.co.za"
          echo "   - FTP_USERNAME: katalyst (or sean@katalystlabs.co.za if that works)"
          echo "   - FTP_PASSWORD: (your hosting account password)"
          echo "2. Plain FTP uses port 21 - should be accessible"
          echo "3. Check if credentials are correct - test manually in FileZilla"
          echo "4. Contact Absolute Hosting support if connection issues persist"

