name: Deploy to Absolute Hosting

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: List files to deploy
        run: |
          echo "Files to be deployed:"
          ls -la
          echo ""
          echo "HTML, CSS, JS files:"
          find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | head -10

      - name: Verify SFTP Secrets
        env:
          SFTP_SERVER_VAR: ${{ secrets.SFTP_SERVER }}
          SFTP_USERNAME_VAR: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD_VAR: ${{ secrets.SFTP_PASSWORD }}
          FTP_SERVER_VAR: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME_VAR: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD_VAR: ${{ secrets.FTP_PASSWORD }}
        run: |
          # Use existing FTP secrets or SFTP-specific ones
          if [ -n "$SFTP_SERVER_VAR" ]; then
            SFTP_SERVER="$SFTP_SERVER_VAR"
          else
            SFTP_SERVER="$FTP_SERVER_VAR"
          fi
          
          if [ -n "$SFTP_USERNAME_VAR" ]; then
            SFTP_USERNAME="$SFTP_USERNAME_VAR"
          else
            SFTP_USERNAME="$FTP_USERNAME_VAR"
          fi
          
          if [ -n "$SFTP_PASSWORD_VAR" ]; then
            SFTP_PASSWORD="$SFTP_PASSWORD_VAR"
          else
            SFTP_PASSWORD="$FTP_PASSWORD_VAR"
          fi
          
          if [ -z "$SFTP_SERVER" ]; then
            echo "âŒ SFTP/FTP_SERVER secret is missing!"
            echo "ðŸ’¡ Add GitHub Secret: FTP_SERVER = ftp.katalystlabs.co.za"
            exit 1
          fi
          if [ -z "$SFTP_USERNAME" ]; then
            echo "âŒ SFTP/FTP_USERNAME secret is missing!"
            echo "ðŸ’¡ Add GitHub Secret: FTP_USERNAME = katalyst"
            exit 1
          fi
          if [ -z "$SFTP_PASSWORD" ]; then
            echo "âŒ SFTP/FTP_PASSWORD secret is missing!"
            echo "ðŸ’¡ Add GitHub Secret: FTP_PASSWORD = (your main hosting account password)"
            exit 1
          fi
          echo "âœ… All SFTP secrets are configured"
          echo "SFTP Server: $SFTP_SERVER"
          echo "SFTP Username: $SFTP_USERNAME"
          echo ""
          echo "â„¹ï¸  Using SFTP (SSH File Transfer Protocol) - secure, uses port 22"
          echo "ðŸ’¡ Using existing FTP_* secrets (or create SFTP_* secrets if preferred)"
          
          # Export for next step
          echo "SFTP_SERVER=$SFTP_SERVER" >> $GITHUB_ENV
          echo "SFTP_USERNAME=$SFTP_USERNAME" >> $GITHUB_ENV
          echo "SFTP_PASSWORD=$SFTP_PASSWORD" >> $GITHUB_ENV

      - name: SFTP Deploy using sshpass and sftp
        timeout-minutes: 5
        run: |
          # Install sshpass for password authentication
          sudo apt-get update -qq
          sudo apt-get install -y sshpass openssh-client
          
          # Create SFTP batch script
          cat > /tmp/sftp_batch.txt << 'SFTPBATCH'
          cd /home/katalyst/public_html
          -mkdir public_html
          put index.html
          put styles.css
          put script.js
          quit
          SFTPBATCH
          
          # Use sshpass to provide password to sftp
          # Note: Remove port :22 if default SSH port works
          sshpass -p "${{ env.SFTP_PASSWORD }}" sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -b /tmp/sftp_batch.txt -P 22 "${{ env.SFTP_USERNAME }}@${{ env.SFTP_SERVER }}" || {
            echo "âŒ SFTP upload failed!"
            echo "Trying alternative: using server IP address instead of domain..."
            sshpass -p "${{ env.SFTP_PASSWORD }}" sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -b /tmp/sftp_batch.txt -P 22 "${{ env.SFTP_USERNAME }}@102.214.8.67" || {
              echo "âŒ SFTP failed with both domain and IP address"
              echo "Possible issues:"
              echo "  1. SFTP/SSH not enabled on server"
              echo "  2. Server requires SSH key instead of password"
              echo "  3. Port 22 is blocked or different port needed"
              echo "  4. Credentials incorrect"
              exit 1
            }
          }
          
          echo "âœ… Files uploaded via SFTP successfully!"


      - name: Verify Deployment
        if: success()
        run: |
          echo "âœ… SFTP Deployment completed successfully!"
          echo ""
          echo "ðŸ“‹ Files deployed to /home/katalyst/public_html/:"
          echo "  - index.html"
          echo "  - styles.css"
          echo "  - script.js"
          echo ""
          echo "ðŸ” Next steps to verify:"
          echo "1. Check your hosting File Manager (/home/katalyst/public_html/ folder)"
          echo "2. Look at file 'Last Modified' timestamps - they should be recent"
          echo "3. Visit your website and clear browser cache (Ctrl+Shift+R or Cmd+Shift+R)"
          echo "4. Try accessing in Incognito/Private mode"

      - name: Deployment Failed - Troubleshooting
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo ""
          echo "ðŸ” Common issues:"
          echo "1. Connection timeout/reset during upload (network issue)"
          echo "2. Server connection limits reached"
          echo "3. FTP passive mode issues"
          echo ""
          echo "âœ… What worked:"
          echo "- Login successful (credentials are correct!)"
          echo "- Connected to server"
          echo "- Created public_html directory"
          echo ""
          echo "âš ï¸  What failed:"
          echo "- SFTP connection or authentication issue"
          echo ""
          echo "ðŸ”„ Solution:"
          echo "1. Verify SFTP credentials in GitHub Secrets:"
          echo "   - FTP_SERVER: ftp.katalystlabs.co.za (or try IP: 102.214.8.67)"
          echo "   - FTP_USERNAME: katalyst"
          echo "   - FTP_PASSWORD: (your main hosting account password)"
          echo "2. SFTP uses port 22 (SSH) - ensure your hosting allows SSH/SFTP access"
          echo "3. Some hosts require SSH key instead of password - contact Absolute Hosting"
          echo "4. Verify SFTP is enabled in your hosting account"
          echo "5. Try testing SFTP manually: sftp katalyst@ftp.katalystlabs.co.za"

